# Написание байт кода

Эта документация для тех, кто не знает как писать байт-код для MoonVM.

## Скрипт генерации байт-кода

Этот скрипт на Python может генерировать бинарный файл согластно структуре байт-кода, этот скрипт может быть реализован самостоятельно на других языках

```python
data = [
#Тут пишется байт-код
]

with open("data.bin", "wb") as f: #записываем байт-код в data.bin
    for item in data:
        if isinstance(item, int):
            f.write(b'\x01')  # Маркер для числа
            f.write(item.to_bytes(4, byteorder='little', signed=True))
        elif isinstance(item, str):
            f.write(b'\x02')  # Маркер для строки
            f.write(item.encode('utf-8') + b'\x00')  # Строка с нулевым байтом
```

## Пояснение к генератору

Так как MoonVM не может предугадать, какой тип данных у него в бинарнике, созданы специальные маркеры, которые помогут понять машине как обрабатывать этот бинарный файл, например как выглядит байт код без маркеров:

```bytecode
0 1 //push 0
6 //print
7 //halt
```

И как с маркерами:

```bytecode
0x01 0 0x01 1 //push 0
0x01 6 //print
0x01 7 //halt
```

Конечно, из за этого бинарный файл больше по объёму, но пока что только так)

## Как писать байт-код и выполнять его

Для каждого опкода есть уникальное числовой номер, и с помощью этих номеров мы и пишем опкод, числовые значения для каждого опкода [найдите здесь](bytecode.md)

В переменной data пишутся обычные Python данные без маркеров, они подставляются сами, например:
```python
data = [
  0, 0, #push 0
  6, #print 
  7 #halt 
]
```
И каждое значение, хоть это строка хоть число пишется через запятую, если у вас иной генератор бинарника, то конечно эта документация может оказаться бесполезной.

Когда мы получили data.bin и не возникло ошибок, в папке build(если делали сборку машины) найдите файл vm и поместите его туда куда вам удобнее, и потом при запуске машины в аргументе указываем путь к бинарнику:

```bash 
./vm путь_к_бинарнику
```

## Пример

Хотим выполнить этот код:

```
LABEL "yes"
	PUSH 1
	PRINT
	JUMP ".end" //Прыгаем в конец чтобы завершить программу
LABEL "start"
	PUSH 90 // a
	PUSH 90 // b
	CMP_EQ "yes" // Если a == b то прыгаем в метку yes 
LABEL ".end"
	HALT
```

И согластно таблице числовых значений:

- LABEL = 20
- PUSH  = 0
- PRINT = 6
- JUMP  = 14
- CMP_EQ = 23
- HALT = 7

Значит в data пишем следущее:

```python
data = [
  20, "yes", #LABEL "yes"
    0, 1 #PUSH 1
    6,   #PRINT 
    14, ".end", #JUMP ".end"
  20, "start", #LABEL "start"
    0, 90, #PUSH 90
    0, 90 #PUSH 90
    23, "yes", #CMP_EQ 23
  20, ".end", #LABEL ".end"
    7 #HALT
]
```

И потом по схеме выше делаем бинарник, и запускаем его через машину, всё!


